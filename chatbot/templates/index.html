<!DOCTYPE html>
<html>
<head>
    <title>TinyLLM Chatbot</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #container {
            display: flex;
            flex-direction: column;
            height: 95vh;
        }
        #messageContainer {
            flex-grow: 1;
            overflow-y: scroll; /* Enable vertical scrolling if needed */
            border-bottom: 1px solid #ccc;
            padding: 10px;
        }
        #inputContainer {
            border-top: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px; /* Add margin for spacing */
        }
        #messageInput {
            flex: 1; /* Takes up all available space */
            padding: 5px;
            margin-right: 10px; /* Add margin for spacing */
        }
        #sendButton {
            margin-left: 10px; /* Add margin for spacing */
            padding: 5px 10px;
            background-color: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
        }
        .user-text {
            color: red;
        }
        .user-input {
            display: flex;
            justify-content: space-between;
            align-items: center; 
        }
        .code-box code {
            display: block; /* Ensures line breaks are preserved */
            font-family: "Courier New", Courier, monospace; /* Use a monospace font for code */
            font-size: 14px;
            line-height: 1.5;
            color: #333;
        }
        /* Style for code container */
        .code-container {
            position: relative;
        }
        /* Style for code-box */
        .code-box {
            background-color: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            overflow-x: auto; /* Enable horizontal scrolling for long lines of code */
        }
        /* Style for copy button */
        .copy-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
        .copy-button:hover {
            background-color: #45a049;
        }
        .notification {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #4CAF50; /* Green color for success */
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .notification.error {
            background-color: #f44336; /* Red color for error */
        }
        #footer {
            text-align: center; 
            font-size: 12px; 
            color: #888; 
            padding-top: 5px;
        }
        #footer a {
            color: #888; 
            text-decoration: none; 
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <div id="container">
        <div id="messageContainer">
            <!-- Messages from the server will be displayed here -->
        </div>
        <div id="inputContainer">
            <!-- User prompts go here -->
            <div class="user-input">
                <textarea id="messageInput" placeholder="Type a message or paste a URL to read..." onkeydown="checkEnter(event)" rows="3" cols="50"></textarea>
                <button onclick="sendMessage()">Send</button>
            </div>
            <div id="footer">TinyLLM Chatbot - <a href="https://github.com/jasonacox/TinyLLM">https://github.com/jasonacox/TinyLLM</a></div>
        </div>
    </div>
    <script>
        // Check for user input
        function checkEnter(event) {
            if (event.key === "Enter") {
                event.preventDefault(); // Prevent form submission
                sendMessage(); 
            }
        }

        // Connect to the Socket.IO server
        const socket = io.connect('http://' + document.domain + ':' + location.port);
        var incode =false;

        // Function to send prompt to the server
        function sendMessage(visible = true) {
            var message = document.getElementById('messageInput').value;
            if (message != "") {
                // Send the message to the server
                socket.emit('message', {
                    prompt: message,
                    show: visible
                });
                // Clear the input field
                document.getElementById('messageInput').value = "";
                // Add the message to the message container
                // const updateContainer = document.getElementById('messageContainer');
                // updateContainer.innerHTML += "<p class='user-text'>" + message + "</p>";
                // ensure we always show latest
                // updateContainer.scrollTop = updateContainer.scrollHeight;
            }
        }

        // Send prompt to LLM
        function sendMessagePOST(visible = true) {
            var dataToSend = {
                prompt: document.getElementById('messageInput').value,
                show: visible
            };

            // Clear form
            document.getElementById('messageInput').value = "";

            // Send a POST request to the Flask route
            fetch('/send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataToSend)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Response from Flask:', data);
                // Handle the response from Flask as needed
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        // Function to handle updates received from the server
        socket.on('update', function(data) {
            const updateContainer = document.getElementById('messageContainer');

            if (data.voice === "done") {
                // Try to identify code and format it for display
                updateContainer.innerHTML = updateContainer.innerHTML.replace(/```([\s\S]*?)```/g, function(match, codeBlock) {
                    const codeTypeMatch = codeBlock.match(/^(\w+)<br>\n/);
                    const codeType = codeTypeMatch ? codeTypeMatch[1] : '';
                    const formattedCodeBlock = codeBlock.replace(/^\w+<br>\n/, '').replace(/<br>\n/g, '\n');

                    // Add a copy-to-clipboard button
                    const codeBox = `<div class="code-container"><pre class="code-box" data-code-type="${codeType}"><code>${formattedCodeBlock}</code></pre><button class="copy-button" onclick="copyToClipboard(this)">Copy ${codeType} code</button></div>\n`;
                    return codeBox;
                });

                // Convert newline and carriage return characters outside the code-box to <br>
                //updateContainer.innerHTML = updateContainer.innerHTML.replace(/([^`])\n/g, '$1<br>');
                //updateContainer.innerHTML = updateContainer.innerHTML.replace(/([^`])\r/g, '$1<br>');
                
                updateContainer.innerHTML = updateContainer.innerHTML.replace(/`([\s\S]*?)`/g, '<code>$1</code>');
            
            }

            if (data.voice === "user") {
                updateContainer.innerHTML += "<p class='user-text'>" + data.update.replace(/[\n\r]/g, "<br>") + "</p>";
            }

            if (data.voice === "ai") {
                updateContainer.innerHTML += data.update.replace(/[\n\r]/g, "<br>\n");
            }

            // Ensure we always show the latest
            updateContainer.scrollTop = updateContainer.scrollHeight;
        });

        // Function to copy text to clipboard
        function copyToClipboard(button) {
            const codeBox = button.parentNode.querySelector('.code-box');
            const codeText = codeBox.textContent || codeBox.innerText;

            navigator.clipboard.writeText(codeText)
                .then(() => {
                    showNotification('Code copied to clipboard!');
                })
                .catch(err => {
                    showNotification('Unable to copy to clipboard', true);
                    console.error('Unable to copy to clipboard', err);
                });
        }

        // Function to display a notification
        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = isError ? 'notification error' : 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            // Automatically remove the notification after a certain time (e.g., 3 seconds)
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }

        function getVersion() {
            fetch('/version')
                .then(response => response.json())
                .then(data => {
                const version = data.version;
                document.getElementById('footer').innerHTML = 'TinyLLM Chatbot ' + version + ' - <a href="https://github.com/jasonacox/TinyLLM">https://github.com/jasonacox/TinyLLM</a>';
                })
                .catch(error => {
                console.error('Error fetching version:', error);
                });
        }

        // Run once on reload
        window.onload = function() {
            document.getElementById('messageInput').value = "Hi";
            sendMessage(false);

            // Set the focus on the text input field
            var textInput = document.getElementById("messageInput"); 
            textInput.focus();

            // Fetch version and update footer
            getVersion();
        };
    </script>
</body>
</html>
